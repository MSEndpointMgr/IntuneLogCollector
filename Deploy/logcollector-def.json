{
    "$schema": "https://schema.management.azure.com/schemas/2021-09-09/uiFormDefinition.schema.json",
    "view": {
        "kind": "Form",
        "properties": {
            "title": "MSEndpointMgr - Intune Logs Collector Deployment",
            "steps": [
                {
                    "name": "basics",
                    "label": "Basics",
                    "elements": [
                        {
                            "name": "resourceScope",
                            "type": "Microsoft.Common.ResourceScope",
                            "location": {
                                "resourceTypes": [
                                    "microsoft.storage/storageaccounts",
                                    "microsoft.web/serverfarms",
                                    "microsoft.insights/components",
                                    "microsoft.web/sites",
                                    "microsoft.operationalinsights/workspaces",
                                    "microsoft.keyvault/vaults",
                                    "microsoft.resources/resourcegroups"
                                ]
                            }
                        },
                        {
                            "name": "environment",
                            "type": "Microsoft.Common.DropDown",
                            "label": "Deployment Environment",
                            "defaultValue": "Development",
                            "toolTip": "Select the environment for deployment. The selected value will be used as a suffix in resource names (e.g., '-dev' for Development, '-prod' for Production).",
                            "constraints": {
                                "allowedValues": [
                                    { "label": "Development", "value": "Development" },
                                    { "label": "Production", "value": "Production" }
                                ],
                                "required": true
                            },
                            "visible": true
                        }
                    ]
                },
                {
                    "name": "storage",
                    "label": "Storage",
                    "description": "Configure the Storage Account for where the gathered compressed log files will be stored.",
                    "elements": [
                        {
                            "name": "storageAccountName",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Storage Account Name",
                            "subLabel": "",
                            "defaultValue": "",
                            "toolTip": "Name of the Storage Account resource. The full name will be '[storageAccountName]-[env]', where [env] is 'dev' or 'prod' depending on the selected environment.",
                            "constraints": {
                                "required": true,
                                "regex": "^[a-z0-9A-Z-]{3,24}$",
                                "validationMessage": "Only alphanumeric and hyphen characters are allowed, and the value must be between 3-24 characters long"
                            },
                            "visible": true
                        },
                        {
                            "name": "checkStorageAccountNameAvailability",
                            "type": "Microsoft.Solutions.ArmApiControl",
                            "request": {
                                "method": "POST",
                                "path": "[concat(subscription().id, '/providers/Microsoft.Storage/checkNameAvailability?api-version=2023-05-01')]",
                                "body": {
                                    "name": "[steps('storage').storageAccountName]",
                                    "type": "Microsoft.Storage/storageAccounts"
                                }
                            }
                        },
                        {
                            "name": "storageAccountSku",
                            "type": "Microsoft.Common.DropDown",
                            "label": "Storage Account Type",
                            "placeholder": "",
                            "defaultValue": "Standard_LRS",
                            "toolTip": "",
                            "constraints": {
                                "allowedValues": [
                                    {
                                        "label": "Premium_LRS",
                                        "value": "Premium_LRS"
                                    },
                                    {
                                        "label": "Premium_ZRS",
                                        "value": "Premium_ZRS"
                                    },
                                    {
                                        "label": "Standard_LRS",
                                        "value": "Standard_LRS"
                                    },
                                    {
                                        "label": "Standard_GRS",
                                        "value": "Standard_GRS"
                                    },
                                    {
                                        "label": "Standard_RAGRS",
                                        "value": "Standard_RAGRS"
                                    },
                                    {
                                        "label": "Standard_ZRS",
                                        "value": "Standard_ZRS"
                                    },
                                    {
                                        "label": "Standard_GZRS",
                                        "value": "Standard_GZRS"
                                    },
                                    {
                                        "label": "Standard_RAGZRS",
                                        "value": "Standard_RAGZRS"
                                    }
                                ],
                                "required": false
                            },
                            "visible": true
                        }
                    ]
                },
                {
                    "name": "functionApp",
                    "label": "Function App",
                    "description": "Configure the Function App that the clients will interact with in order to determine what log file rules should be used for gathering, but also to retrieve a SAS token for authentication against the Storage Account for upload of the gathered compressed log files.",
                    "elements": [
                        {
                            "name": "functionAppName",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Function App Name",
                            "subLabel": "",
                            "defaultValue": "",
                            "toolTip": "Name of the Function App resource. The full name will be '[functionAppName]-[env]', where [env] is 'dev' or 'prod' depending on the selected environment.",
                            "constraints": {
                                "validations": [
                                    {
                                        "isValid": "[not(equals(steps('functionApp').appServiceAvailabilityApi.nameAvailable, false))]",
                                        "message": "[concat('Error with the url: ', steps('functionApp').functionAppName, '. Reason: ', steps('functionApp').appServiceAvailabilityApi.reason)]"
                                    },
                                    {
                                        "regex": "^[a-z0-9A-Z-]{3,32}$",
                                        "message": "Only alphanumeric and hyphen characters are allowed, and the value must be between 3-32 characters long"
                                    }
                                ],
                                "required": true
                            },
                            "visible": true
                        },
                        {
                            "name": "functionAppSku",
                            "type": "Microsoft.Common.DropDown",
                            "label": "Function App Type",
                            "placeholder": "",
                            "defaultValue": "Y1",
                            "toolTip": "",
                            "constraints": {
                                "allowedValues": [
                                    {
                                        "label": "Consumption",
                                        "value": "Y1"
                                    },
                                    {
                                        "label": "PremiumV2",
                                        "value": "EP1"
                                    }
                                ],
                                "required": false
                            },
                            "visible": true
                        },
                        {
                            "name": "appServiceAvailabilityApi",
                            "type": "Microsoft.Solutions.ArmApiControl",
                            "request": {
                                "method": "POST",
                                "path": "[concat(subscription().id, '/providers/Microsoft.Web/checknameavailability?api-version=2023-01-01')]",
                                "body": {
                                    "name": "[steps('functionApp').functionAppName]",
                                    "type": "Microsoft.Web/sites"
                                }
                            }
                        }
                    ]
                },
                {
                    "name": "keyVault",
                    "label": "Key Vault",
                    "description": "Configure the Key Vault to ensure secrets used by the Function App are stored securely.",
                    "elements": [
                        {
                            "name": "keyVaultName",
                            "type": "Microsoft.Common.TextBox",
                            "label": "Key Vault Name",
                            "subLabel": "",
                            "defaultValue": "",
                            "toolTip": "Name of the Key Vault resource. The full name will be '[keyVaultName]-[env]', where [env] is 'dev' or 'prod' depending on the selected environment.",
                            "constraints": {
                                "required": true,
                                "regex": "^[a-zA-Z0-9-]{3,24}$",
                                "validationMessage": "Only alphanumeric and hyphen characters are allowed, and the value must be between 3-24 characters long"
                            },
                            "visible": true
                        }
                    ]
                },
                {
                    "name": "tags",
                    "label": "Tags",
                    "elements": [
                        {
                            "name": "tags",
                            "type": "Microsoft.Common.TagsByResource",
                            "resources": [
                                "Microsoft.Web/serverfarms",
                                "Microsoft.Web/sites"
                            ]
                        }
                    ]
                }
            ]
        },
        "outputs": {
            "kind": "ResourceGroup",
            "location": "[steps('basics').resourceScope.location.name]",
            "resourceGroupId": "[steps('basics').resourceScope.resourceGroup.id]",
            "parameters": {
                "storageAccountName": "[steps('storage').storageAccountName]",
                "storageAccountSku": "[steps('storage').storageAccountSku]",
                "functionAppName": "[steps('functionApp').functionAppName]",
                "functionAppSku": "[steps('functionApp').functionAppSku]",
                "keyVaultName": "[steps('keyVault').keyVaultName]",
                "tags": "[steps('tags').tags]",
                "environment": "[steps('basics').environment]"
            }
        }
    }
}